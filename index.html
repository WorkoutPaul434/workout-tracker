<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Tracker (Cloud)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
        body { margin: 0; padding: 0; background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%); min-height: 100vh; color: white; overflow-x: hidden;}
        .gradient-bg { background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);}
        .glass-effect { background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); border: 1px solid rgba(220, 38, 38, 0.2);}
        .card-hover { transition: all 0.3s ease;}
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(220, 38, 38, 0.2);}
        .glow { box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);}
        .pulse-animation { animation: pulse 2s infinite;}
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .mobile-safe { padding-bottom: env(safe-area-inset-bottom);}
        input:focus, select:focus { outline: none; ring: 2px solid #dc2626;}
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none;}
        .scrollbar-hide::-webkit-scrollbar { display: none;}
        .light-mode { background: linear-gradient(135deg, #f9fafb 0%, #e5e7eb 100%) !important; color: #111 !important;}
        .edit-overlay {
            background: rgba(0,0,0,0.5); position: fixed; z-index: 1000; top: 0; left: 0; width: 100vw; height: 100vh;
            display: flex; align-items: center; justify-content: center;
        }
        .edit-modal {
            background: #18181b;
            color: #fff;
            border-radius: 1rem;
            padding: 2rem 1.5rem;
            min-width: 320px;
            max-width: 95vw;
            box-shadow: 0 0 40px #0008;
            z-index: 1001;
            max-height: 90vh;
            overflow-y: auto;
        }
        .edit-modal input, .edit-modal select, .edit-modal textarea {
            background: #27272a;
            color: #fff;
            width: 100%;
            border-radius: 0.5rem;
            border: 1px solid #444;
            padding: 0.5rem 0.75rem;
            margin-bottom: 1rem;
        }
        .edit-modal label { margin-top: 0.25rem; margin-bottom: 0.25rem; display: block; }
        .edit-modal button { margin-right: 0.5rem; }
        .edit-action-btn { cursor: pointer; opacity: 0.8; transition: opacity 0.18s;}
        .edit-action-btn:hover { opacity: 1; }
        .pencil-btn {
            display:inline-flex; align-items:center; justify-content:center;
            width:2.2em; height:2.2em; background:#23272b;
            border-radius:0.7em; border:1.5px solid #555;
            color:#bbb; margin-left:0.5em; margin-right:0.2em;
            box-shadow:0 1px 2px #0005; font-size:1.3em;
            transition:background 0.15s,border 0.15s, color 0.12s;
        }
        .pencil-btn:active, .pencil-btn:focus, .pencil-btn:hover {
            background:#333740; border-color:#dc2626; color:#fff;
        }
        @media (max-width: 640px) {
            .edit-modal { min-width:95vw; padding:1rem 0.2rem;}
        }
        @media (max-width: 800px) {
            .sticky-complete-btn {
                position:fixed; z-index:900; left:0; right:0; bottom:0;
                width:100vw; border-radius:0; border-left:none; border-right:none;
                margin:0; padding:0.5rem 2vw;
                box-shadow:0 -2px 18px #0004;
            }
        }
    </style>
</head>
<body>
<div id="root"></div>
<script>
const firebaseConfig = {
    apiKey: "AIzaSyADRPIZ5BQoFqtevuVpadsRif5F3soKlug",
    authDomain: "workout-tracker-62e56.firebaseapp.com",
    projectId: "workout-tracker-62e56",
    storageBucket: "workout-tracker-62e56.appspot.com",
    messagingSenderId: "195952292211",
    appId: "1:195952292211:web:f3ce90c79878de6c3a1506"
};
firebase.initializeApp(firebaseConfig);
</script>
<script type="text/babel">
// --- Helper Hooks and Components ---
function useCloudState(user, key, initialValue) {
    const [state, setState] = React.useState(initialValue);
    const firstLoad = React.useRef(true);

    React.useEffect(() => {
        if (!user) return;
        const db = firebase.firestore();
        const ref = db.collection('users').doc(user.uid);
        let unsub = ref.onSnapshot(doc => {
            if (doc.exists && doc.data()[key] !== undefined) {
                setState(doc.data()[key]);
            }
        });
        return () => unsub && unsub();
    }, [user, key]);

    React.useEffect(() => {
        if (!user) return;
        if (firstLoad.current) { firstLoad.current = false; return; }
        const db = firebase.firestore();
        const ref = db.collection('users').doc(user.uid);
        ref.set({ [key]: state }, { merge: true });
    }, [user, key, state]);

    return [state, setState];
}

function ProgressChart({ history, lift }) {
    const ref = React.useRef();
    React.useEffect(() => {
        if (!window.Chart) {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            script.onload = renderChart;
            document.head.appendChild(script);
        } else {
            renderChart();
        }
        function renderChart() {
            if (!history || !history.length) return;
            const ctx = ref.current.getContext('2d');
            if (ref.current.chart) { ref.current.chart.destroy(); }
            const data = (history || [])
                .map(entry => {
                    let sets = [];
                    if (entry.exercises && typeof entry.exercises === "object") {
                        Object.values(entry.exercises).forEach(e => {
                            if (e && e.lift === lift && Array.isArray(e.sets)) {
                                sets = sets.concat((e.sets || []).filter(s => s && s.done && s.weight && s.reps));
                            }
                        });
                    }
                    const bestSet = sets.reduce((best, s) => {
                        if (!s.weight || !s.reps) return best;
                        const est = s.weight * (1 + s.reps / 30);
                        return !best || est > best.est ? { ...s, est } : best;
                    }, null);
                    return bestSet ? { date: entry.date, est: Math.round(bestSet.est) } : null;
                })
                .filter(Boolean);
            if (!data.length) return;
            ref.current.chart = new window.Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => d.date),
                    datasets: [{
                        label: lift.charAt(0).toUpperCase() + lift.slice(1) + ' (Estimated 1RM)',
                        data: data.map(d => d.est),
                        fill: false,
                        borderColor: 'rgb(239,68,68)',
                        tension: 0.2,
                        pointBackgroundColor: 'rgb(239,68,68)'
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: 'Date' }},
                        y: { title: { display: true, text: 'Estimated 1RM (kg)' }, beginAtZero: false }
                    }
                }
            });
        }
    }, [history, lift]);
    return (
        <canvas ref={ref} width={320} height={180} className="bg-gray-900 rounded-xl block mx-auto mb-4" />
    );
}

function PencilIcon({className}) {
    return (
        <svg className={className} width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"
            viewBox="0 0 24 24">
            <rect x="0" y="0" width="24" height="24" fill="none"/>
            <path d="M16.862 3.487a2.2 2.2 0 0 1 3.11 3.109l-11.48 11.48-3.618.507.507-3.618 11.481-11.478z"/>
        </svg>
    );
}

function EditExerciseModal({ show, onClose, exercise, onSave, isNew, days, allLifts, onlyForWeek, setOnlyForWeek }) {
    const [name, setName] = React.useState(exercise?.name || "");
    const [sets, setSets] = React.useState(exercise?.sets || "");
    const [lift, setLift] = React.useState(exercise?.lift || "");
    const [day, setDay] = React.useState(exercise?.day || days[0] || "");
    React.useEffect(() => {
        setName(exercise?.name || "");
        setSets(exercise?.sets || "");
        setLift(exercise?.lift || "");
        setDay(exercise?.day || days[0] || "");
    }, [exercise, days]);
    if (!show) return null;
    return (
        <div className="edit-overlay">
            <div className="edit-modal">
                <h3 className="text-lg font-semibold mb-2">{isNew ? "Add New Exercise" : "Edit Exercise"}</h3>
                <form
                    onSubmit={e => {
                        e.preventDefault();
                        if (!name.trim()) return;
                        onSave({ ...exercise, name: name.trim(), sets: sets.trim(), lift: lift || null, day });
                    }}>
                    <label>Day</label>
                    <select value={day} onChange={e => setDay(e.target.value)}>
                        {days.map(d => (
                            <option value={d} key={d}>{d.charAt(0).toUpperCase() + d.slice(1)}</option>
                        ))}
                    </select>
                    <input
                        value={name}
                        onChange={e => setName(e.target.value)}
                        placeholder="Exercise name"
                        maxLength={32}
                        name="exerciseName"
                    />
                    <input
                        value={sets}
                        onChange={e => setSets(e.target.value)}
                        placeholder="Sets prescription"
                        maxLength={32}
                        name="setsPrescrip"
                    />
                    <select
                        value={lift || ""}
                        onChange={e => setLift(e.target.value)}
                        name="liftLink"
                    >
                        <option value="">None</option>
                        {allLifts.map(l => (
                            <option value={l} key={l}>{l.charAt(0).toUpperCase() + l.slice(1)}</option>
                        ))}
                    </select>
                    {setOnlyForWeek &&
                        <div className="mb-2">
                            <label className="inline-flex items-center space-x-2">
                                <input type="checkbox" checked={onlyForWeek} onChange={e => setOnlyForWeek(e.target.checked)} />
                                <span>Only for this week</span>
                            </label>
                        </div>
                    }
                    <div className="flex justify-end">
                        <button type="button" onClick={onClose} className="bg-gray-700 px-3 py-1 rounded mr-2">Cancel</button>
                        <button type="submit" className="gradient-bg px-3 py-1 rounded text-white">{isNew ? "Add" : "Save"}</button>
                    </div>
                </form>
            </div>
        </div>
    );
}

function getMonday(date) {
    const d = new Date(date);
    const day = d.getDay(), diff = d.getDate() - day + (day === 0 ? -6:1);
    return new Date(d.setDate(diff));
}

function lastWeekStats(history, day, exName) {
    if (!history || !history.length) return null;
    const now = new Date();
    const thisMonday = getMonday(now);
    const lastMonday = new Date(thisMonday); lastMonday.setDate(thisMonday.getDate() - 7);
    const lastSunday = new Date(thisMonday); lastSunday.setDate(thisMonday.getDate() - 1);
    let maxWeight = null, maxReps = null;
    history.forEach(entry => {
        const d = new Date(entry.date);
        if (d < lastMonday || d > lastSunday) return;
        if (entry.day === day && entry.exercises) {
            Object.values(entry.exercises).forEach(e => {
                if (e.name === exName && Array.isArray(e.sets)) {
                    e.sets.forEach(set => {
                        if (set.weight && (!maxWeight || set.weight > maxWeight)) maxWeight = set.weight;
                        if (set.reps && (!maxReps || set.reps > maxReps)) maxReps = set.reps;
                    });
                }
            });
        }
    });
    if (maxWeight || maxReps) return { maxWeight, maxReps };
    return null;
}

function parseSetsWithWeights(sets, lift, oneRepMaxes) {
    let parsed = sets;
    const patterns = [ /(\d+-\d+)%/g, /(\d+)%/g ];
    patterns.forEach(pattern => {
        parsed = parsed.replace(pattern, (match, percentage) => {
            if (!lift || !oneRepMaxes[lift]) return match;
            if (percentage.includes('-')) {
                const [min, max] = percentage.split('-').map(Number);
                const minWeight = Math.round((oneRepMaxes[lift] * min / 100)*4)/4;
                const maxWeight = Math.round((oneRepMaxes[lift] * max / 100)*4)/4;
                return `${percentage}% (${minWeight}-${maxWeight}kg)`;
            } else {
                const weight = Math.round((oneRepMaxes[lift] * parseInt(percentage)/100)*4)/4;
                return `${percentage}% (${weight}kg)`;
            }
        });
    });
    return parsed;
}

// --- Main App Component ---
function WorkoutTracker() {
    const [user, setUser] = React.useState(null);
    const [authLoading, setAuthLoading] = React.useState(true);
    React.useEffect(() => {
        const unsub = firebase.auth().onAuthStateChanged(u => { setUser(u); setAuthLoading(false); });
        return () => unsub();
    }, []);

    const [oneRepMaxes, setOneRepMaxes] = useCloudState(user, 'oneRepMaxes', { bench: 102, deadlift: 143, squat: 125 });
    const [workoutHistory, setWorkoutHistory] = useCloudState(user, 'workoutHistory', []);
    const [activeTab, setActiveTab] = useCloudState(user, 'activeTab', 'workout');
    const [selectedDay, setSelectedDay] = useCloudState(user, 'selectedDay', 'monday');
    const [isPeaking, setIsPeaking] = useCloudState(user, 'isPeaking', false);
    const [peakingWeek, setPeakingWeek] = useCloudState(user, 'peakingWeek', 1);
    const [lightMode, setLightMode] = useCloudState(user, 'lightMode', false);

    const defaultSplit = {
        monday: [
            { name: "Barbell Bench Press", sets: "1 top single @ 85-90%, then 3x5-8 @ 75-80%", lift: "bench" },
            { name: "Pec Fly (Machine or DB)", sets: "2x8-10", lift: null },
            { name: "Seated DB Shoulder Press", sets: "2x6-8", lift: null },
            { name: "Lateral Raises", sets: "3x10-12", lift: null },
            { name: "Triceps Pushdowns", sets: "2x8-10", lift: null }
        ],
        tuesday: [
            { name: "Speed Deadlifts", sets: "4x2 @ 65-70%", lift: "deadlift" },
            { name: "Weighted Pull-Ups", sets: "3x6-8", lift: null },
            { name: "Chest-Supported T-Bar Row", sets: "2x6-8", lift: null },
            { name: "Narrow Cable Row", sets: "2x8-10", lift: null },
            { name: "Incline Cable Curls", sets: "2x8-10", lift: null },
            { name: "Cable Hammer Curls", sets: "1x8-10", lift: null }
        ],
        wednesday: [
            { name: "Back Squat", sets: "1 top single @ 85-88%, then 3x5-6 @ 80-85%", lift: "squat" },
            { name: "Lying Leg Curl", sets: "3x8-10", lift: null },
            { name: "Romanian Deadlift (RDL)", sets: "3x6-8", lift: null },
            { name: "Standing Calf Raises", sets: "3x10-12", lift: null },
            { name: "Adductors", sets: "2x10-12", lift: null },
            { name: "Abductors", sets: "2x10-12", lift: null },
            { name: "Leg Extensions (optional)", sets: "2x10-12", lift: null }
        ],
        friday: [
            { name: "Incline DB Press", sets: "2x6-8 (last set to failure)", lift: null },
            { name: "Paused Flat Bench Press", sets: "1 top single @ 85%, then 2x5-7 @ 75%", lift: "bench" },
            { name: "Neutral Grip Pull-Ups", sets: "3x6-8", lift: null },
            { name: "Chest Supported Row", sets: "2x8-10", lift: null },
            { name: "Lateral Raises", sets: "2x10-12", lift: null },
            { name: "Overhead Triceps Extensions", sets: "2x8-10", lift: null },
            { name: "Preacher or Incline DB Curls", sets: "2x8-10", lift: null }
        ],
        saturday: [
            { name: "Deadlift", sets: "1 top single @ 85-90%, then 2-3x5 @ 75-80%", lift: "deadlift" },
            { name: "Hack Squat or Safety Bar Squat", sets: "3x6-8", lift: null },
            { name: "Back Extensions/Good Mornings", sets: "3x8-10", lift: null },
            { name: "Standing Calf Raises", sets: "3x10-12", lift: null },
            { name: "Lying Leg Curl", sets: "2x8-10", lift: null }
        ],
    };
    const [split, setSplit] = useCloudState(user, 'customSplit', defaultSplit);
    const [weekSplit, setWeekSplit] = useCloudState(user, 'weekSplit', null);

    const [setInputs, setSetInputs] = React.useState({});
    const [editMode, setEditMode] = React.useState(false);
    const [editDay, setEditDay] = React.useState("");
    const [editExercise, setEditExercise] = React.useState(null);
    const [editModalOpen, setEditModalOpen] = React.useState(false);
    const [editIsNew, setEditIsNew] = React.useState(false);
    const [editOnlyForWeek, setEditOnlyForWeek] = React.useState(false);

    const allLifts = ['bench', 'deadlift', 'squat'];
    const allDays = ['monday', 'tuesday', 'wednesday', 'friday', 'saturday'];
    const emojiMap = { monday:"üí™", tuesday:"üî•", wednesday:"ü¶µ", friday:"üí•", saturday:"‚ö°" };
    const dayTitles = { monday:"Push (Bench Focus)", tuesday:"Pull (Deadlift & Back)", wednesday:"Legs (Quad Focus)", friday:"Upper (Incline & Bench)", saturday:"Lower (Heavy Deadlift)" };

    const getPlanForDay = (day) => {
        if (weekSplit && weekSplit[day]) return weekSplit[day];
        return split[day] || [];
    };

    const calculateWeight = (lift, percentage) => {
        const oneRM = oneRepMaxes && oneRepMaxes[lift] ? oneRepMaxes[lift] : 0;
        return Math.round((oneRM * percentage / 100) * 4) / 4;
    };
    const parseExerciseWithWeights = (exercise) => {
        return parseSetsWithWeights(exercise.sets, exercise.lift, oneRepMaxes);
    };
    const getCurrentDayName = () => {
        const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
        return days[new Date().getDay()];
    };
    const isRestDay = (day) => day === 'thursday' || day === 'sunday';

    React.useEffect(() => {
        const today = getCurrentDayName();
        if (!isRestDay(today)) setSelectedDay(today);
    }, []);

    const getPeakingModifications = (exercise, week) => {
        if (!exercise.lift) return exercise.sets;
        let sets = exercise.sets;
        switch (week) {
            case 1:
                if (exercise.name.match(/Bench Press|Deadlift|Squat/)) {
                    sets = exercise.sets.replace(/85-90%|85-88%/, '88-90%').replace(/3x5-8|3x5-6|2-3x5/, '2x4') + ' (Heavy Practice)';
                }
                break;
            case 2:
                if (exercise.name.match(/Bench Press|Deadlift|Squat/)) {
                    sets = exercise.sets.replace(/85-90%|85-88%/, '92-94%').replace(/3x5-8|3x5-6|2-3x5/, '1x3') + ' (Volume Drop)';
                }
                break;
            case 3:
                if (exercise.name.match(/Bench Press|Deadlift|Squat/)) {
                    sets = 'Max Week - Test 1RM (Fri/Sat)';
                } else {
                    sets = 'Technique sets: 3x2 @ 60-65%';
                }
                break;
            default:
                sets = exercise.sets;
        }
        return parseSetsWithWeights(sets, exercise.lift, oneRepMaxes);
    };
    // Add these near the top of your component:
const [useProgression, setUseProgression] = React.useState(false);
const [progressionWeek, setProgressionWeek] = React.useState(1);

const progressionPlan = [
  { week: 1, topSingle: 85, backoff: 75, note: "Solid baseline" },
  { week: 2, topSingle: 87, backoff: 77, note: "Slightly increase accessory effort" },
  { week: 3, topSingle: 89, backoff: 80, note: "Taper a couple sets to manage fatigue" },
  { week: 4, topSingle: 91, backoff: 82.5, note: "Push hard, then transition or deload" },
];

const progressionData = progressionPlan.find(w => w.week === progressionWeek);
    const handleEditClick = (day) => {
        setEditDay(day);
        setEditMode(true);
    };
    const handleEditExercise = (ex, day) => {
        setEditExercise({ ...ex, day });
        setEditIsNew(false);
        setEditModalOpen(true);
        setEditOnlyForWeek(false);
    };
    const handleAddExercise = (day) => {
        setEditExercise({ name: "", sets: "", lift: "", day });
        setEditIsNew(true);
        setEditModalOpen(true);
        setEditOnlyForWeek(false);
    };
    const handleDeleteExercise = (idx, day, forWeek) => {
        if (forWeek) {
            setWeekSplit(prev => ({
                ...prev,
                [day]: (prev?.[day] || []).filter((_,i) => i !== idx)
            }));
        } else {
            setSplit(prev => ({
                ...prev,
                [day]: (prev?.[day] || []).filter((_,i) => i !== idx)
            }));
        }
    };
    const handleSaveExercise = (updatedEx) => {
        const targetDay = updatedEx.day;
        if (editOnlyForWeek) {
            setWeekSplit(prev => ({
                ...prev,
                [targetDay]: [
                    ...(prev?.[targetDay] || []).filter(e=>e.name!==editExercise.name),
                    updatedEx
                ]
            }));
        } else {
            setSplit(prev => ({
                ...prev,
                [targetDay]: [
                    ...(prev?.[targetDay] || []).filter(e=>e.name!==editExercise.name),
                    updatedEx
                ]
            }));
        }
        setEditModalOpen(false);
        setEditExercise(null);
    };
    const handleEditOrder = (day, idx, dir, forWeek) => {
        const routine = forWeek ? (weekSplit?.[day] || []) : (split?.[day] || []);
        if ((dir === -1 && idx === 0) || (dir === 1 && idx === routine.length-1)) return;
        const newRoutine = [...routine];
        [newRoutine[idx], newRoutine[idx+dir]] = [newRoutine[idx+dir], newRoutine[idx]];
        if (forWeek) {
            setWeekSplit(prev => ({...prev, [day]: newRoutine }));
        } else {
            setSplit(prev => ({...prev, [day]: newRoutine }));
        }
    };

    const resetWeekPlan = async () => {
        setWeekSplit(null);
        setEditModalOpen(false);
        if (user) {
            const db = firebase.firestore();
            const ref = db.collection('users').doc(user.uid);
            await ref.update({ weekSplit: null });
        }
        alert("This week's plan has been reset to the main split.");
    };

    const restoreDefaultSplit = async () => {
        setSplit(defaultSplit);
        if (user) {
            const db = firebase.firestore();
            const ref = db.collection('users').doc(user.uid);
            await ref.update({ customSplit: defaultSplit });
        }
        alert("All changes have been reset to the original split.");
    };

    const saveWorkout = () => {
        const today = new Date().toISOString().split('T')[0];
        const dayPlan = getPlanForDay(selectedDay);
        const exercisesData = {};
        dayPlan.forEach(ex => {
            const exerciseKey = `${selectedDay}-${ex.name}`;
            exercisesData[exerciseKey] = {
                name: ex.name,
                lift: ex.lift || null,
                sets: [1,2,3,4].map(setNum => setInputs[`${exerciseKey}-set${setNum}`] || { weight: '', reps: '', done: false })
            };
        });
        setWorkoutHistory(prev => [...(prev || []), {
            date: today,
            day: selectedDay,
            workout: dayTitles[selectedDay] || "",
            exercises: exercisesData
        }]);
        setSetInputs({});
    };

    React.useEffect(() => {
        if (lightMode) document.body.classList.add('light-mode');
        else document.body.classList.remove('light-mode');
    }, [lightMode]);

    if (authLoading) return <div className="flex items-center justify-center min-h-screen">Loading...</div>;
    if (!user) {
        return (
            <div className="flex flex-col items-center justify-center min-h-screen">
                <h1 className="text-3xl font-bold mb-8">Workout Tracker</h1>
                <button
                    onClick={() => firebase.auth().signInWithPopup(new firebase.auth.GoogleAuthProvider())}
                    className="gradient-bg text-white px-8 py-4 rounded-xl text-xl hover:scale-105 transition-all glow"
                >Sign in with Google</button>
            </div>
        );
    }

    return (
        <div className={`min-h-screen ${lightMode ? 'light-mode' : 'bg-gray-900'} mobile-safe`}>
            {/* Header and nav */}
            <div className="sticky top-0 z-50 glass-effect border-b border-red-600/30">
                <div className="max-w-7xl mx-auto px-4 py-4">
                    <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-3">
                            <div className="w-10 h-10 gradient-bg rounded-xl flex items-center justify-center glow">
                                <span className="text-xl font-bold">üí™</span>
                            </div>
                            <h1 className="text-xl md:text-2xl font-bold text-white">Workout Tracker</h1>
                        </div>
                        <div className="text-sm text-gray-300 hidden sm:block">
                            {new Date().toLocaleDateString('en-US', { 
                                weekday: 'short', 
                                month: 'short', 
                                day: 'numeric' 
                            })}
                        </div>
                    </div>
                    <div className="flex space-x-1 mt-4 overflow-x-auto scrollbar-hide">
                        {[
                            { id: 'workout', label: 'Workout', icon: 'üéØ' },
                            { id: 'progress', label: 'Progress', icon: 'üìà' },
                            { id: 'settings', label: 'Settings', icon: '‚öôÔ∏è' }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)}
                                className={`flex items-center space-x-2 px-4 py-2 rounded-xl font-medium transition-all whitespace-nowrap ${
                                    activeTab === tab.id 
                                        ? 'gradient-bg text-white glow' 
                                        : 'text-gray-300 hover:text-white hover:bg-gray-800/50'
                                }`}
                            >
                                <span>{tab.icon}</span>
                                <span className="text-sm md:text-base">{tab.label}</span>
                            </button>
                        ))}
                        <button
                            onClick={() => firebase.auth().signOut()}
                            className="ml-auto text-xs text-red-300 underline"
                            style={{marginLeft: "auto"}}
                        >Sign out</button>
                    </div>
                </div>
            </div>
            <div className="max-w-7xl mx-auto px-2 py-3 sm:px-4 sm:py-6 space-y-6">
                {/* Workout Tab */}
                {activeTab === 'workout' && (
                    <>
                        <div className="glass-effect rounded-2xl p-2 md:p-6 card-hover">
                            <h2 className="text-lg font-semibold mb-4 flex items-center text-white">
                                <span className="mr-2">üìÖ</span>
                                Weekly Split
                                <div className="flex flex-row gap-2 ml-4">
        <button
            onClick={resetWeekPlan}
            className="text-xs border px-2 py-1 rounded bg-gray-800/40 text-gray-200 hover:bg-red-900/80"
            title="Reset to Default"
        >
            Reset week
        </button>
        <button
            onClick={restoreDefaultSplit}
            className="text-xs border px-2 py-1 rounded bg-gray-800/40 text-gray-200 hover:bg-red-900/80"
            title="Restore original split"
        >
            Restore original split
        </button>
    </div>
</h2>
                            <div className="grid grid-cols-2 sm:grid-cols-7 gap-2">
                                {['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map((day) => {
                                    const dayKey = day.toLowerCase();
                                    const isToday = getCurrentDayName() === dayKey;
                                    const isRest = isRestDay(dayKey);
                                    return (
                                        <div
                                            key={day}
                                            className={`p-3 rounded-xl text-center cursor-pointer transition-all transform hover:scale-105 relative ${
                                                selectedDay === dayKey
                                                    ? 'gradient-bg border-2 border-red-400 text-white glow'
                                                    : isToday && !isRest
                                                    ? 'bg-red-800/50 border-2 border-red-600 text-white pulse-animation'
                                                    : isRest
                                                    ? 'bg-gray-800 border border-gray-600 text-gray-400'
                                                    : 'bg-gray-800 border border-gray-600 text-gray-300 hover:bg-gray-700'
                                            }`}
                                            onClick={() => !isRest && setSelectedDay(dayKey)}
                                        >
                                            <div className="font-medium text-sm mb-1">{day.slice(0, 3)}</div>
                                            <div className="text-xs">
                                                {isRest ? 'üò¥ Rest' : (
                                                    <div>
                                                        <div className="text-lg mb-1">{emojiMap[dayKey]}</div>
                                                        <div>{(dayTitles[dayKey] || "").split(' ')[0]}</div>
                                                    </div>
                                                )}
                                            </div>
                                            {!isRest && <span
                                                className="absolute top-1 right-2 pencil-btn"
                                                title="Edit Day"
                                                onClick={e => { e.stopPropagation(); handleEditClick(dayKey); }}
                                                style={{boxSizing:"content-box"}}
                                            ><PencilIcon /></span>}
                                        </div>
                                    );
                                })}
                            </div>
                         <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 space-y-3 sm:space-y-0">
  <h3 className="text-lg font-semibold text-white flex items-center">
    <span className="mr-2">üéØ</span>
    Training Mode
  </h3>
  <div className="flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-4">
    {/* Peaking Block */}
    <label className="flex items-center">
      <input
        type="checkbox"
        checked={isPeaking}
        onChange={(e) => setIsPeaking(e.target.checked)}
        className="w-5 h-5 rounded border-gray-600 text-red-600 focus:ring-red-500 bg-gray-800"
      />
      <span className="ml-2 text-sm font-medium text-white">Peaking Block</span>
    </label>
    {isPeaking && (
      <select
        value={peakingWeek}
        onChange={(e) => setPeakingWeek(parseInt(e.target.value))}
        className="border border-gray-600 rounded-xl px-3 py-2 text-sm bg-gray-800 text-white focus:ring-2 focus:ring-red-500 ml-2"
      >
        <option value={1}>Week 1 - Heavy Practice</option>
        <option value={2}>Week 2 - Volume Drop</option>
        <option value={3}>Week 3 - Max Week</option>
      </select>
    )}

    {/* Progression Plan */}
    <label className="flex items-center ml-4">
      <input
        type="checkbox"
        checked={useProgression}
        onChange={(e) => setUseProgression(e.target.checked)}
        className="w-5 h-5 rounded border-gray-600 text-blue-600 focus:ring-blue-500 bg-gray-800"
      />
      <span className="ml-2 text-sm font-medium text-white">Progression Plan</span>
    </label>
    {useProgression && (
      <select
        value={progressionWeek}
        onChange={(e) => setProgressionWeek(parseInt(e.target.value))}
        className="border border-gray-600 rounded-xl px-3 py-2 text-sm bg-gray-800 text-white focus:ring-2 focus:ring-blue-500 ml-2"
      >
        <option value={1}>Week 1</option>
        <option value={2}>Week 2</option>
        <option value={3}>Week 3</option>
        <option value={4}>Week 4</option>
      </select>
    )}
  </div>
</div>

{/* Peaking Block info */}
{isPeaking && (
  <div className="bg-red-900/50 border border-red-700/50 rounded-xl p-4">
    <p className="text-sm text-red-100">
      {peakingWeek === 1 && "üî• Heavy Practice: Top single @ 88-90%, reduce volume slightly"}
      {peakingWeek === 2 && "‚ö° Volume Drop: Top single @ 92-94%, skip some accessory sets"}
      {peakingWeek === 3 && "üèÜ Max Week: Light technique work Mon-Wed, test 1RM Fri/Sat"}
    </p>
  </div>
)}

{/* Progression Plan info */}
{useProgression && progressionData && (
  <div className="bg-blue-900/50 border border-blue-700/50 rounded-xl p-4 mt-2">
    <p className="text-sm text-blue-100">
      <strong>Top Single:</strong> {progressionData.topSingle}%<br />
      <strong>Backoff:</strong> {progressionData.backoff}%<br />
      <em>{progressionData.note}</em>
    </p>
  </div>
)}
                                     
                        {/* Current Workout */}
                        {selectedDay && !isRestDay(selectedDay) && (
                            <div className="glass-effect rounded-2xl p-2 md:p-6 card-hover relative">
                                <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 space-y-3 sm:space-y-0">
                                    <div className="flex items-center space-x-3">
                                        <span className="text-2xl">{emojiMap[selectedDay]}</span>
                                        <h2 className="text-xl font-semibold text-white">
                                            {dayTitles[selectedDay]}
                                        </h2>
                                    </div>
                                    {/* Desktop only - Complete Workout button */}
                                    <button
                                        onClick={saveWorkout}
                                        className="gradient-bg text-white px-6 py-3 rounded-xl hover:scale-105 transition-all glow flex items-center space-x-2 hidden sm:flex"
                                    >
                                        <span>‚úÖ</span>
                                        <span>Complete Workout</span>
                                    </button>
                                </div>
                                <div className="space-y-4 pb-20 sm:pb-0">
                                    {getPlanForDay(selectedDay).map((exercise, index) => {
                                        const displaySets = isPeaking 
                                            ? getPeakingModifications(exercise, peakingWeek)
                                            : parseExerciseWithWeights(exercise);
                                        const exerciseKey = `${selectedDay}-${exercise.name}`;
                                        // For last week stats
                                        const stats = lastWeekStats(workoutHistory, selectedDay, exercise.name);
                                        return (
                                            <div key={index} className="border border-red-600/30 rounded-xl p-3 md:p-4 bg-gray-800/50 hover:bg-gray-800/70 transition-all">
                                                <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-2 sm:mb-3 space-y-2 sm:space-y-0">
                                                    <div className="flex items-center">
                                                        <h3 className="font-medium text-white text-lg">{exercise.name}</h3>
                                                        <span
                                                            className="pencil-btn"
                                                            title="Edit exercise"
                                                            onClick={() => { handleEditExercise(exercise, selectedDay); setEditOnlyForWeek(false); }}
                                                        ><PencilIcon /></span>
                                                    </div>
                                                    {exercise.lift && (
                                                        <span className="text-xs gradient-bg text-white px-3 py-1 rounded-full">
                                                            {exercise.lift.toUpperCase()}
                                                        </span>
                                                    )}
                                                </div>
                                                <div className="flex flex-wrap items-center gap-2 mb-2">
                                                    <p className="text-xs text-gray-300 font-mono bg-gray-900/50 px-3 py-2 rounded-lg w-fit">{displaySets}</p>
                                                    {stats &&
                                                        <span className="ml-4 text-xs text-yellow-200 bg-yellow-900/40 px-2 py-1 rounded font-mono">
                                                            Last week: {stats.maxWeight ? `${stats.maxWeight}kg` : ""}{stats.maxWeight && stats.maxReps ? ", " : ""}{stats.maxReps ? `${stats.maxReps} reps` : ""}
                                                        </span>
                                                    }
                                                </div>
                                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                                    {[1, 2, 3, 4].map(setNum => {
                                                        const setKey = `${exerciseKey}-set${setNum}`;
                                                        const input = setInputs[setKey] || { weight: '', reps: '', done: false };
                                                        return (
                                                            <div
                                                                key={setNum}
                                                                className={`flex space-x-2 items-center p-2 rounded-lg transition-all
                                                                    ${input.done ? 'bg-gray-700 opacity-60' : 'bg-gray-900/50'}`}
                                                            >
                                                                <input
                                                                    type="number"
                                                                    placeholder="Weight (kg)"
                                                                    step="0.25"
                                                                    value={input.weight}
                                                                    onChange={e =>
                                                                        setSetInputs(prev => ({
                                                                            ...prev,
                                                                            [setKey]: { ...input, weight: e.target.value }
                                                                        }))
                                                                    }
                                                                    className="flex-1 px-3 py-2 border border-gray-600 rounded-lg text-base bg-gray-900 text-white placeholder-gray-500 focus:ring-2 focus:ring-red-500"
                                                                    disabled={false}
                                                                    style={{fontSize:"1em", minWidth: 0}}
                                                                />
                                                                <input
                                                                    type="number"
                                                                    placeholder="Reps"
                                                                    value={input.reps}
                                                                    onChange={e =>
                                                                        setSetInputs(prev => ({
                                                                            ...prev,
                                                                            [setKey]: { ...input, reps: e.target.value }
                                                                        }))
                                                                    }
                                                                    className="w-16 px-3 py-2 border border-gray-600 rounded-lg text-base bg-gray-900 text-white placeholder-gray-500 focus:ring-2 focus:ring-red-500"
                                                                    disabled={false}
                                                                    style={{fontSize:"1em"}}
                                                                />
                                                                <button
                                                                    className={`px-3 py-2 rounded-lg text-base text-white transition-all ${
                                                                        input.done ? 'bg-gray-500' : 'gradient-bg hover:scale-105'
                                                                    }`}
                                                                    onClick={() =>
                                                                        setSetInputs(prev => ({
                                                                            ...prev,
                                                                            [setKey]: { ...input, done: !input.done }
                                                                        }))
                                                                    }
                                                                    type="button"
                                                                    aria-label={input.done ? "Mark set as not done" : "Mark set as done"}
                                                                >
                                                                    ‚úì
                                                                </button>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                                {/* Mobile sticky Complete Workout button */}
                                <button
                                    onClick={saveWorkout}
                                    className="gradient-bg text-white sm:hidden sticky-complete-btn px-6 py-4 rounded-xl hover:scale-105 transition-all glow flex items-center justify-center space-x-2"
                                    style={{fontSize:"1.2em", width:"96vw", left:"2vw", margin:"0 auto"}}
                                >
                                    <span>‚úÖ</span>
                                    <span>Complete Workout</span>
                                </button>
                            </div>
                        )}
                        {selectedDay && isRestDay(selectedDay) && (
                            <div className="glass-effect rounded-2xl p-8 text-center card-hover">
                                <div className="text-6xl mb-4">üò¥</div>
                                <h2 className="text-2xl font-semibold mb-3 text-white">Rest Day</h2>
                                <p className="text-gray-300">Take a well-deserved break and let your muscles recover!</p>
                            </div>
                        )}
                    </>
                )}
                {/* Progress Tab */}
                {activeTab === 'progress' && (
                    <div className="glass-effect rounded-2xl p-4 md:p-6 card-hover">
                        <h2 className="text-lg font-semibold mb-4 flex items-center text-white">
                            <span className="mr-2">üìä</span>
                            Workout History & Progress
                        </h2>
                        <div className="flex flex-wrap gap-6 mb-8">
                            <ProgressChart history={workoutHistory || []} lift="bench" />
                            <ProgressChart history={workoutHistory || []} lift="squat" />
                            <ProgressChart history={workoutHistory || []} lift="deadlift" />
                        </div>
                        {(!workoutHistory || workoutHistory.length === 0) ? (
                            <div className="text-center py-12">
                                <div className="text-6xl mb-4">üìà</div>
                                <p className="text-gray-400 text-lg">
                                    No workouts completed yet.<br/>Start tracking your progress!
                                </p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {workoutHistory.slice(-10).reverse().map((workout, index) => (
                                    <div key={index} className="border border-red-600/30 rounded-xl p-4 bg-gray-800/50 hover:bg-gray-800/70 transition-all">
                                        <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between space-y-2 sm:space-y-0">
                                            <div>
                                                <h3 className="font-medium text-white flex items-center">
                                                    <span className="mr-2">üèãÔ∏è</span>
                                                    {workout.workout}
                                                </h3>
                                                <p className="text-sm text-gray-400">{workout.date}</p>
                                            </div>
                                            <button
                                                className="text-xs text-red-400 underline"
                                                onClick={() => {
                                                    setWorkoutHistory(prev => prev.filter((_, i) => i !== prev.length - 1 - index));
                                                }}
                                            >Delete</button>
                                        </div>
                                        {/* Expanded workout details */}
                                        <div className="mt-3 space-y-2">
                                            {workout.exercises && Object.entries(workout.exercises).map(([ekey, exercise]) => (
                                                <div key={ekey}>
                                                    <span className="font-semibold text-white">{exercise.name}</span>
                                                    {exercise.lift && (
                                                        <span className="ml-2 text-xs text-red-300 font-mono">[{exercise.lift.toUpperCase()}]</span>
                                                    )}
                                                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 mt-1">
                                                        {(exercise.sets || []).map((set, idx) => (
                                                            <div key={idx} className={`text-xs px-2 py-1 rounded
                                                                ${set && set.done ? 'bg-green-700 text-white' : 'bg-gray-700 text-gray-400'}`}>
                                                                {set && set.weight && set.reps ? `${set.weight}kg x ${set.reps}` : '--'}
                                                                {set && set.done && <span className="ml-1">‚úì</span>}
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                )}
                {/* Settings Tab */}
                {activeTab === 'settings' && (
                    <div className="space-y-6">
                        <div className="glass-effect rounded-2xl p-4 md:p-6 card-hover">
                            <h2 className="text-lg font-semibold mb-6 text-white flex items-center">
                                <span className="mr-2">üéØ</span>
                                One Rep Max Settings
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {allLifts.map((lift) => (
                                    <div key={lift} className="space-y-2">
                                        <label className="block text-sm font-medium text-gray-300 capitalize flex items-center">
                                            <span className="mr-2">
                                                {lift === 'bench' ? 'üèãÔ∏è' : lift === 'deadlift' ? '‚ö°' : 'ü¶µ'}
                                            </span>
                                            {lift} 1RM (kg)
                                        </label>
                                        <input
                                            type="number"
                                            step="0.25"
                                            value={oneRepMaxes[lift]}
                                            onChange={(e) => setOneRepMaxes(prev => ({
                                                ...prev,
                                                [lift]: parseFloat(e.target.value) || 0
                                            }))}
                                            className="w-full px-4 py-3 border border-gray-600 rounded-xl focus:ring-2 focus:ring-red-500 focus:border-red-500 bg-gray-800 text-white text-lg font-semibold"
                                        />
                                    </div>
                                ))}
                            </div>
                            <div className="mt-8 p-6 bg-gray-900/70 rounded-xl border border-red-600/20">
                                <h3 className="font-medium mb-4 text-white flex items-center">
                                    <span className="mr-2">üßÆ</span>
                                    Calculated Working Weights
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {allLifts.map((lift) => (
                                        <div key={lift} className="space-y-2">
                                            <div className="font-medium capitalize text-red-400 flex items-center">
                                                <span className="mr-2">
                                                    {lift === 'bench' ? 'üèãÔ∏è' : lift === 'deadlift' ? '‚ö°' : 'ü¶µ'}
                                                </span>
                                                {lift}
                                            </div>
                                            <div className="space-y-1 text-sm">
                                                <div className="flex justify-between text-gray-300">
                                                    <span>65%:</span>
                                                    <span className="font-mono font-semibold">{calculateWeight(lift, 65)}kg</span>
                                                </div>
                                                <div className="flex justify-between text-gray-300">
                                                    <span>75%:</span>
                                                    <span className="font-mono font-semibold">{calculateWeight(lift, 75)}kg</span>
                                                </div>
                                                <div className="flex justify-between text-gray-300">
                                                    <span>85%:</span>
                                                    <span className="font-mono font-semibold">{calculateWeight(lift, 85)}kg</span>
                                                </div>
                                                <div className="flex justify-between text-gray-300">
                                                    <span>90%:</span>
                                                    <span className="font-mono font-semibold">{calculateWeight(lift, 90)}kg</span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="mt-8">
                                <label className="flex items-center space-x-2">
                                    <input
                                        type="checkbox"
                                        checked={lightMode}
                                        onChange={e => setLightMode(e.target.checked)}
                                        className="w-5 h-5 rounded border-gray-600 text-red-600 focus:ring-red-500 bg-gray-800"
                                    />
                                    <span className="text-sm font-medium text-white">Enable Light Mode</span>
                                </label>
                            </div>
                        </div>
                    </div>
                )}
            </div>
            {/* Edit Modal */}
            <EditExerciseModal
                show={editModalOpen}
                onClose={() => { setEditModalOpen(false); setEditExercise(null); }}
                exercise={editExercise}
                onSave={handleSaveExercise}
                isNew={editIsNew}
                days={allDays}
                allLifts={allLifts}
                onlyForWeek={editOnlyForWeek}
                setOnlyForWeek={setEditOnlyForWeek}
            />
            {/* Edit Day Modal */}
            {editMode && (
                <div className="edit-overlay">
                    <div className="edit-modal" style={{minWidth: 380}}>
                        <h3 className="font-semibold text-lg mb-2">Edit {editDay.charAt(0).toUpperCase()+editDay.slice(1)} Routine</h3>
                        <div className="mb-4">
                            <button className="bg-green-700 text-white px-3 py-1 rounded mr-2"
                                onClick={() => { handleAddExercise(editDay); setEditIsNew(true); setEditOnlyForWeek(false); }}>Add Exercise</button>
                            <button className="bg-blue-700 text-white px-3 py-1 rounded"
                                onClick={() => { handleAddExercise(editDay); setEditIsNew(true); setEditOnlyForWeek(true); }}>Add only for this week</button>
                        </div>
                        <ul>
                        {(weekSplit?.[editDay] || split?.[editDay] || []).map((ex, idx) => (
                            <li key={idx} className="flex items-center mb-2 space-x-2">
                                <span className="font-mono text-sm">{ex.name}</span>
                                <span className="text-xs text-gray-400">{ex.sets}</span>
                                <button title="Edit"
                                    className="pencil-btn"
                                    onClick={() => { handleEditExercise(ex, editDay); setEditOnlyForWeek(false); }}>
                                    <PencilIcon />
                                </button>
                                <button title="Edit only for this week"
                                    className="pencil-btn"
                                    onClick={() => { handleEditExercise(ex, editDay); setEditOnlyForWeek(true); }}>
                                    <PencilIcon />
                                    <span className="ml-1 text-xs">üóìÔ∏è</span>
                                </button>
                                <button title="Move up"
                                    className="edit-action-btn"
                                    onClick={() => handleEditOrder(editDay, idx, -1, !!weekSplit?.[editDay])}>
                                    ‚¨ÜÔ∏è
                                </button>
                                <button title="Move down"
                                    className="edit-action-btn"
                                    onClick={() => handleEditOrder(editDay, idx, 1, !!weekSplit?.[editDay])}>
                                    ‚¨áÔ∏è
                                </button>
                                <button title="Delete"
                                    className="edit-action-btn text-red-300"
                                    onClick={() => handleDeleteExercise(idx, editDay, !!weekSplit?.[editDay])}>
                                    üóëÔ∏è
                                </button>
                            </li>
                        ))}
                        </ul>
                        <div className="flex justify-end mt-4">
                            <button onClick={()=>setEditMode(false)}
                                className="bg-gray-700 px-3 py-1 rounded">Done</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
    
}

ReactDOM.render(<WorkoutTracker />, document.getElementById('root'));
</script>
</body>
</html>
